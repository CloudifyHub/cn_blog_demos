-- Run As: CNDEMO
-- CNDEMO_ADDRESSES
DROP TABLE CNDEMO_ADDRESSES;

CREATE TABLE CNDEMO_ADDRESSES 
 (ADDRESS_ID              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY CONSTRAINT CNDEMO_ADDRESSES_PK PRIMARY KEY NOT NULL, 
  SOURCE_REF              VARCHAR2(25)  NOT NULL,
  STATUS_CODE             VARCHAR2(10)  NOT NULL,    -- PENDING, WIP, PROCESSED, ERROR
  ADDRESS_NAME            VARCHAR2(100),
  ISO_COUNTRY_CODE        VARCHAR2(5)   NOT NULL,
  STREET                  VARCHAR2(100) NOT NULL,
  CITY                    VARCHAR2(100),
  REGION                  VARCHAR2(100),
  POSTAL_CODE             VARCHAR2(100),
  MATCH_COUNT             NUMBER,
  MATCH_ADDRESS_JSON      VARCHAR2(10000),
  MATCH_CODE              NUMBER,
  MATCH_VECTOR            VARCHAR2(20),
  MATCH_LONGITUDE         NUMBER,
  MATCH_LATITUDE          NUMBER,
  MATCH_ERROR_MESSAGE     VARCHAR2(20),
  MATCH_MESSAGE           VARCHAR2(250),
  STATUS_DATE_TIME        TIMESTAMP (6) WITH LOCAL TIME ZONE,
  STATUS_MSG              VARCHAR2(250),
	CREATION_DATE           TIMESTAMP (6) WITH LOCAL TIME ZONE NOT NULL, 
	CREATED_BY              VARCHAR2(255) NOT NULL, 
	LAST_UPDATE_DATE        TIMESTAMP (6) WITH LOCAL TIME ZONE NOT NULL, 
	LAST_UPDATED_BY         VARCHAR2(255) NOT NULL);

CREATE OR REPLACE EDITIONABLE TRIGGER CNDEMO_ADDRESSES_BIU 
   before insert or update on CNDEMO_ADDRESSES
   for each row
BEGIN
  IF inserting then
    IF :new.CREATED_BY IS NULL THEN
      :new.CREATED_BY       := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'),USER);
    END IF;
    IF :new.CREATION_DATE IS NULL THEN
      :new.CREATION_DATE    := current_timestamp;
    END IF;
    IF :new.LAST_UPDATED_BY IS NULL THEN
      :new.LAST_UPDATED_BY  := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'),USER);
    END IF;
    IF :new.LAST_UPDATE_DATE IS NULL THEN
      :new.LAST_UPDATE_DATE := current_timestamp;
    END IF;
  END IF;
  IF updating THEN
    :new.LAST_UPDATED_BY  := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'),USER);
    :new.LAST_UPDATE_DATE := current_timestamp;
  END IF;
end;
/
